---
title: å¤§ä½¬æ‰€ç†è§£çš„æ¥å£è®¾è®¡
urlname: how-i-understand-restful-api
date: 2018-02-05 10:07:24
category: æ‚è°ˆ
---

åŸæ–‡é“¾æ¥ï¼š[https://segmentfault.com/a/1190000013703264](https://segmentfault.com/a/1190000013703264)

<!-- more -->

## æ¥å£å‚æ•°å®šä¹‰

æ¥å£è®¾è®¡ä¸­å¾€å¯ä»¥æŠ½è±¡å‡ºä¸€äº›æ–°çš„å…¬å…±å‚æ•°ï¼Œæˆ‘ç›®å‰èƒ½æƒ³åˆ°äº†ä¸€äº›è¾ƒä¸ºå¸¸è§çš„å…¬å…±æ¥å£å‚æ•°å¦‚ä¸‹ï¼š

|å…¬å…±å‚æ•°|å«æ„|å®šä¹‰è¯¥å‚æ•°çš„æ„ä¹‰|
|-|-|-|
|timestamp|æ¯«ç§’çº§æ—¶é—´æˆ³|1.å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¶é—´æ ‡ç¤º 2.åç«¯å¯ä»¥åšè¯·æ±‚è¿‡æœŸéªŒè¯ 3.è¯¥å‚æ•°å‚ä¸ç­¾åç®—æ³•å¢åŠ ç­¾åçš„å”¯ä¸€æ€§|
|app_key|ç­¾åå…¬é’¥|ç­¾åç®—æ³•çš„å…¬é’¥ï¼Œåç«¯é€šè¿‡å…¬é’¥å¯ä»¥å¾—åˆ°å¯¹åº”çš„ç§é’¥|
|sign|æ¥å£ç­¾å|é€šè¿‡è¯·æ±‚çš„å‚æ•°å’Œå®šä¹‰å¥½çš„ç­¾åç®—æ³•ç”Ÿæˆæ¥å£ç­¾åï¼Œä½œç”¨é˜²æ­¢ä¸­é—´äººç¯¡æ”¹è¯·æ±‚å‚æ•°|
|did|è®¾å¤‡ID|è®¾å¤‡çš„å”¯ä¸€æ ‡ç¤ºï¼Œç”Ÿæˆè§„åˆ™ä¾‹å¦‚androidçš„macåœ°å€çš„md5å’Œiosæ›¾ä»Šudid(ç›®å‰æ— æ³•è·å–)çš„md5, 1:æ•°æ®æ”¶é›† 2.ä¾¿äºé—®é¢˜è¿½è¸ª 3.æ¶ˆæ¯æ¨é€æ ‡ç¤º|

## æ¥å£çš„ç‰ˆæœ¬åŒ–

æ¥å£ç‰ˆæœ¬åŒ–ç®—æ˜¯å†å²éš¾é¢˜ï¼Œæ›¾ç»ä¹Ÿå»è°ƒç ”äº†å¾ˆå¤šå…³äºæ¥å£ç‰ˆæœ¬åŒ–çš„èµ„æ–™å’Œè®¾è®¡ï¼Œæœ€åæˆ‘å¾—åˆ°çš„ç»“è®ºå¤§è‡´å¦‚ä¸‹ï¼š

æ¥å£çš„ç‰ˆæœ¬åŒºåˆ†ä¸º

- å¤§ç‰ˆæœ¬
    - åŸåˆ™ï¼šå¤§ç‰ˆæœ¬çš„æ•°é‡æœ€å¤šæ§åˆ¶åˆ°5ä¸ªä»¥å†…(æˆ‘ä¸ªäººè·Ÿå€¾å‘äº3ä¸ª)ï¼Œè¶…è¿‡ç‰ˆæœ¬é™åˆ¶çš„ç‰ˆæœ¬æç¤ºå‡çº§åˆ°æ–°ç‰ˆæœ¬

    - æ–¹æ¡ˆ
        uriæºå¸¦ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ï¼šv1/user/get
        è¯·æ±‚å‚æ•°ï¼Œä¾‹å¦‚ï¼šuser/get?v=1.0

- å°ç‰ˆæœ¬
    - åŸåˆ™ï¼šè‡ªå·±æŠŠæ§å§ğŸ˜„

    - æ–¹æ¡ˆ
        uriæºå¸¦ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ï¼šv1/user/get_01
        è¯·æ±‚å‚æ•°ï¼Œå°æ•°ç‚¹å³è¾¹å°±æ˜¯å°ç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼šuser/get?v=1.1

## æ¥å£çš„å®‰å…¨æ€§
æ¥å£çš„è®¾è®¡è‚¯å®šç»•ä¸å¼€å®‰å…¨è¿™ä¸¤ä¸ªå­—ï¼Œä¸ºäº†è¾¾åˆ°å°½å¯èƒ½çš„å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½çš„å¢åŠ è¢«æ”»å‡»çš„éš¾åº¦ï¼Œä»¥ä¸‹æ˜¯æˆ‘äº†è§£å’Œä½¿ç”¨åˆ°çš„ä¸€äº›å¸¸è§çš„æ‰‹æ®µå»å¢åŠ æ¥å£çš„å®‰å…¨æ€§(httpsè¿™é‡Œå°±ä¸è®¨è®ºäº†)ï¼š

    è¿‡æœŸéªŒè¯ï¼ç­¾åéªŒè¯ï¼é‡æ”¾æ”»å‡»ï¼é™æµï¼è½¬ä¹‰

ä¼ªä»£ç å¦‚ä¸‹ï¼š
```php
// è¿‡æœŸéªŒè¯
if (microtime(true)*1000 - $_REQUEST['timestamp'] > 5000) {
    throw new \Exception(401, 'Expired request');
}
```

```php
// ç­¾åéªŒè¯(å…¬é’¥æ ¡éªŒçœç•¥)
$params = ksort($_REQUEST);
unset($params['sign']);
$sign = md5(sha1(implode('-', $params) . $_REQUEST['app_key']));
if ($sign !== $_REQUEST['sign']) {
    throw new \Exception(401, 'Invalid sign');
}
```

```php
/**
 * é‡æ”¾æ”»å‡»
 * @params noise string éšæœºå­—ç¬¦ä¸²æˆ–éšæœºæ­£æ•´æ•°ï¼Œä¸ Timestamp è”åˆèµ·æ¥, ç”¨äºé˜²æ­¢é‡æ”¾æ”»å‡» ä¾‹å¦‚è…¾è®¯äº‘æ˜¯6ä½éšæœºæ­£æ•´æ•°
 */
$key = md5("{$_REQUEST['REQUEST_URI']}-{$_REQUEST['timestamp']}-{$_REQUEST['noise']}-{$_REQUEST['did']}");
if ($redisInstance->exists($key)) {
    throw new \Exception(401, 'Repeated request');
}
```

```php
// é™æµ
$key = md5("{$_REQUEST['REQUEST_URI']}-{$_REQUEST['REMOTE_ADDR']}-{$_REQUEST['did']}");
if ($redisInstance->get($key) > 60) {
    throw new \Exception(401, 'Request limit');
}
$redisInstance->incre($key);
```

```php
// è½¬ä¹‰
$username = htmlspecialchars($_REQUEST['username']);
```


## æ¥å£çš„ä»£ç è®¾è®¡ -> è§£è€¦ä¸šåŠ¡ å³æ’å³ç”¨
> è¿™ä¸ªè¿‡ç¨‹çš„å…³é”®å­—ï¼šæŠ½è±¡æˆç±» å‰ç½®ä¸­é—´ä»¶ æ³¨å…¥

æ¥ç€å°±æ˜¯æˆ‘ä»¬ä»£ç è®¾è®¡çš„å±‚é¢äº†ï¼Œå¦‚ä½•æŠ½è±¡å…¬å…±çš„éƒ¨åˆ†ä¸ä¸šåŠ¡ä»£ç è§£è€¦ã€‚

ä¸€èˆ¬å†™æ³•, å®šä¹‰ä¸ªå…¨å±€å‡½æ•°ï¼Œç„¶åæ¯ä¸ªæ¥å£å¼€å§‹æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼š

```php
// å…¨å±€å®šä¹‰ä¸€ä¸ªå‡½æ•°
function check () {
    // æ ¡éªŒå…¬å…±å‚æ•°
    # code ...
    // æ ¡éªŒç­¾å
    # code ...
    // æ ¡éªŒé¢‘ç‡
    # code ...
    // ç­‰ç­‰...
}
```

äºŒèˆ¬å†™æ³•, å®šä¹‰ä¸ªçˆ¶ç±»æ–¹æ³•ï¼Œç„¶åæ¯ä¸ªæ¥å£ç±»ç»§æ‰¿è¯¥æ¥å£ï¼Œæ„é€ å‡½æ•°è°ƒç”¨æ”¹æ–¹æ³•ï¼Œå…¶å®å’Œä¸Šé¢çš„æ¢æ±¤ä¸æ¢è¯ï¼š

```php
// çˆ¶ç±»æ–¹æ³•

class father
{
    public function __construct()
    {
        $this->check();
    }

    public function check () {
        // æ ¡éªŒå…¬å…±å‚æ•°
        # code ...
        // æ ¡éªŒç­¾å
        # code ...
        // æ ¡éªŒé¢‘ç‡
        # code ...
        // ç­‰ç­‰...
    }
}
```

é‡ç‚¹æ¥äº†ï¼Œæˆ‘æå€¡çš„ç¬¬ä¸‰èˆ¬å†™æ³•ï¼Œå¯¹è±¡é“¾å’Œå‰ç½®ä¸­é—´ä»¶ï¼š

```php
/**
 * æ£€éªŒæŠ½è±¡ç±»
 */
abstract class Check
{
    /**
     * ä¸‹ä¸€ä¸ªcheckå®ä½“
     *
     * @var object
     */
    private $nextCheckInstance;
    
    /**
     * æ ¡éªŒæ–¹æ³•
     *
     * @param Request $request è¯·æ±‚å¯¹è±¡
     */
    abstract public function operate(Request $request);

    /**
     * è®¾ç½®è´£ä»»é“¾ä¸Šçš„ä¸‹ä¸€ä¸ªå¯¹è±¡
     *
     * @param Check $check
     */
    public function setNext(Check $check)
    {
        $this->nextCheckInstance = $check;
        return $check;
    }

    /**
     * å¯åŠ¨
     *
     * @param Request $request è¯·æ±‚å¯¹è±¡
     */
    public function start(Request $request)
    {
        $this->doCheck($request);
        // è°ƒç”¨ä¸‹ä¸€ä¸ªå¯¹è±¡
        if (! empty($this->nextCheckInstance)) {
            $this->nextCheckInstance->start($request);
        }
    }
}

// æ ¡éªŒå…¬å…±å‚æ•°ç±»
class ParamsCheck extends Check
{
    public function operate()
    {
       // æ ¡éªŒå…¬å…±å‚æ•°
        # code ... 
    }
}

// æ ¡éªŒç­¾åç±»
class SignCheck extends Check
{
    public function operate()
    {
       // æ ¡éªŒç­¾å
        # code ... 
    }
}

// ç­‰ç­‰...

// å‰ç½®ä¸­é—´ä»¶ç±»
class FrontMiddleware
{
    public function run()
    {
        // åˆå§‹åŒ–ä¸€ä¸ªï¼šå¿…ä¼ å‚æ•°æ ¡éªŒçš„check
        $checkParams   =  new ParamsCheck();
        // åˆå§‹åŒ–ä¸€ä¸ªï¼šç­¾åcheck
        $checkSign     =  new SignCheck();
        // åˆå§‹åŒ–ä¸€ä¸ªï¼šé¢‘ç‡check
        $checkFrequent =  new FrequentCheck();
        // ç­‰ç­‰...

        // æ„æˆå¯¹è±¡é“¾
        $checkParams->setNext($checkSign)
                    ->setNext($checkFrequent)
                    ...
        // å¯åŠ¨
        $checkParams->start();
    }
}
```

## æ¥å£çš„å¯è¯»æ€§
å…³äºå¯è¯»æ€§çš„ä¸å¾—ä¸æåˆ°çš„å°±æ˜¯RESTFULï¼Œè¿™é‡Œæˆ‘å°±ä¸è®¨è®ºRESTFULï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œè¡¥å……ç›¸å…³çŸ¥è¯†ã€‚å…³äºæ¥å£è®¾è®¡å¯è¯»æ€§çš„æˆ‘çš„ä¸€äº›æ€è€ƒï¼š

- url
    - éRESTFUL: èµ„æºï¼èµ„æºï¼æ“ä½œ(åŠ¨è¯)ï¼Œ ä¾‹å¦‚ content/article/get -> è·å–å†…å®¹èµ„æºä¸‹çš„ä¸€ç¯‡æ–‡ç« èµ„æº
    - RESTFUL: èµ„æºï¼èµ„æºï¼èµ„æºï¼Œ ä¾‹å¦‚ get content/article/1 -> è·å–å†…å®¹èµ„æºä¸‹æ–‡ç« IDä¸º1çš„æ–‡ç« èµ„æº

- method
    - éRESTFUL: getä¾¿äºæŸ¥nginxæ—¥å¿—ï¼Œä¸Šä¼ èµ„æºpost, æ²¡å•¥ç¡¬æ€§è¦æ±‚
    - RESTFUL: ç¬¦åˆRESTFULçš„æ€æƒ³
- request params: ä¸ªäººæ›´é’çäºä¸‹åˆ’çº¿å‘½åï¼Œé€‚å½“çš„å•è¯ç¼©å†™

- response params: å“åº”çš„codeè¦ç¬¦åˆhttp status
    - 200 -> æ­£å¸¸
    - 400 -> ç¼ºå°‘å…¬å…±å¿…ä¼ å‚æ•°æˆ–è€…ä¸šåŠ¡å¿…ä¼ å‚æ•°
    - 401 -> æ¥å£æ ¡éªŒå¤±è´¥ ä¾‹å¦‚ç­¾å
    - 403 -> æ²¡æœ‰è¯¥æ¥å£çš„è®¿é—®æƒé™
    - 499 -> ä¸Šæ¸¸æœåŠ¡å“åº”æ—¶é—´è¶…è¿‡æ¥å£è®¾ç½®çš„è¶…æ—¶æ—¶é—´
    - 500 -> ä»£ç é”™è¯¯
    - 501 -> ä¸æ”¯æŒçš„æ¥å£method
    - 502 -> ä¸Šæ¸¸æœåŠ¡è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®
    - 503 -> ä¸Šæ¸¸æœåŠ¡è¶…æ—¶
    - 504 -> ä¸Šæ¸¸æœåŠ¡ä¸å¯ç”¨

```json
// å“åº”çš„æ ¼å¼
{
    "code": 200,
    "msg": "ok",
    "data": {

    }
}
```

## æ¥å£æ–‡æ¡£
å¥½çš„æ¥å£æ–‡æ¡£å°±æ˜¯ç”Ÿäº§åŠ›ï¼Œ swagger + api blueprint è‡ªè¡Œgoogleå§ğŸ˜„

## æˆ‘é‡åˆ°çš„å‘

è¿™é‡Œé‡åˆ°çš„ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å‘å°±æ˜¯httpåè®®å†å²é—ç•™çš„bugï¼š

> ä¸åŒºåˆ†urlé‡Œçš„ç©ºæ ¼ å’ŒåŠ å·â•

å¸¦æ¥çš„é—®é¢˜å°±æ˜¯urldecodeä¼šæŠŠå‚æ•°é‡Œçš„+å·è½¬ä¸ºç©ºæ ¼ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯çš„å°±å¾—ä½¿ç”¨rawurldecodeé˜²æ­¢+è½¬æˆç©ºæ ¼ã€‚æ¯”å¦‚åšæ¥å£çš„å‚æ•°æ ¡éªŒçš„æ—¶å€™ï½